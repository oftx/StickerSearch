<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语义素材搜索</title>
    <style>
        :root {
            --md-sys-font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --md-sys-primary: #005ac1; --md-sys-on-primary: #ffffff; --md-sys-primary-container: #d8e2ff; --md-sys-on-primary-container: #001a41; --md-sys-surface: #fdfbff; --md-sys-surface-container: #f0f2f5; --md-sys-on-surface: #1b1b1f; --md-sys-on-surface-variant: #44474f; --md-sys-outline: #c4c6d0; --md-sys-shadow: 0 1px 2px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.1); --md-sys-error: #ba1a1a; --md-sys-error-container: #ffdad6; --md-sys-on-error-container: #410002; --md-sys-success: #386a20; --md-sys-success-container: #d9f0c3; --md-sys-on-success-container: #092100;
            --border-radius-large: 28px; --border-radius-medium: 16px; --border-radius-small: 8px; --transition-duration: 0.3s; --transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --md-sys-primary: #adc6ff; --md-sys-on-primary: #002e69; --md-sys-primary-container: #004494; --md-sys-on-primary-container: #d8e2ff; --md-sys-surface: #121316; --md-sys-surface-container: #1b1b1f; --md-sys-on-surface: #e3e2e6; --md-sys-on-surface-variant: #c4c6d0; --md-sys-outline: #8e9099; --md-sys-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 2px 6px rgba(0, 0, 0, 0.3); --md-sys-error: #ffb4ab; --md-sys-error-container: #93000a; --md-sys-on-error-container: #ffdad6; --md-sys-success: #b5d3a5; --md-sys-success-container: #205108; --md-sys-on-success-container: #d9f0c3;
            }
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--md-sys-font-family); background-color: var(--md-sys-surface-container); color: var(--md-sys-on-surface); margin: 0; display: flex; flex-direction: column; min-height: 100vh; transition: background-color var(--transition-duration), color var(--transition-duration); }
        .hidden { display: none !important; }
        .app-view { min-height: 100vh; width: 100%; }
        .main-container { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; padding: 24px; text-align: center; }
        .header { width: 100%; display: flex; justify-content: flex-end; padding: 16px; position: fixed; top: 0; right: 0; z-index: 100; }
        .settings-btn { background-color: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 50%; width: 44px; height: 44px; font-size: 24px; color: var(--md-sys-on-surface-variant); display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-duration), transform var(--transition-duration); }
        .settings-btn:hover { background-color: rgba(0,0,0,0.08); transform: rotate(60deg); }
        .title { font-size: 3rem; font-weight: 700; color: var(--md-sys-primary); margin-bottom: 2.5rem; }
        .search-container { display: flex; align-items: center; justify-content: center; gap: 16px; width: 100%; max-width: 900px; margin-bottom: 2.5rem; }
        .search-bar { width: 100%; position: relative; flex-grow: 1; margin-bottom: 0; }
        .search-input { width: 100%; padding: 18px 60px 18px 24px; font-size: 1.1rem; border: 2px solid var(--md-sys-outline); border-radius: var(--border-radius-large); background-color: var(--md-sys-surface); color: var(--md-sys-on-surface); outline: none; transition: border-color var(--transition-duration), box-shadow var(--transition-duration); }
        .search-input:focus { border-color: var(--md-sys-primary); box-shadow: 0 0 0 4px var(--md-sys-primary-container); }
        .search-button { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background-color: transparent; color: var(--md-sys-primary); border: none; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; font-weight: bold; transition: background-color var(--transition-duration), transform var(--transition-duration); }
        .search-button:hover { transform: translateY(-50%) scale(1.05); }
        .search-button:active { transform: translateY(-50%) scale(0.95); }
        .options-bar { display: inline-flex; align-items: center; margin-top: 0; background-color: var(--md-sys-surface); padding: 12px 16px; border-radius: var(--border-radius-large); border: 2px solid var(--md-sys-outline); gap: 8px; color: var(--md-sys-on-surface-variant); box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: box-shadow var(--transition-duration), border-color var(--transition-duration); flex-shrink: 0; }
        .options-bar:focus-within { box-shadow: 0 0 0 4px var(--md-sys-primary-container); border-color: var(--md-sys-primary); }
        .options-bar label { font-size: 0.9rem; }
        .options-bar input[type="number"] { width: 50px; border: none; background: transparent; color: var(--md-sys-on-surface); text-align: center; font-size: 1rem; font-weight: 500; padding: 4px; -moz-appearance: textfield; }
        .options-bar input[type="number"]::-webkit-outer-spin-button, .options-bar input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .options-bar input[type="number"]:focus { outline: none; }
        .advanced-search-toggle-btn { background-color: var(--md-sys-surface); color: var(--md-sys-on-surface-variant); border: 2px solid var(--md-sys-outline); border-radius: var(--border-radius-large); padding: 0 24px; font-size: 1rem; cursor: pointer; transition: all var(--transition-duration); height: 60px; flex-shrink: 0; }
        .advanced-search-toggle-btn:hover { border-color: var(--md-sys-primary); }
        .advanced-search-toggle-btn.active { background-color: var(--md-sys-primary-container); color: var(--md-sys-on-primary-container); border-color: var(--md-sys-primary); }
        .advanced-search-panel { width: 100%; max-width: 900px; margin: -2rem auto 1rem; padding: 20px; background-color: var(--md-sys-surface); border-radius: var(--border-radius-large); border: 1px solid var(--md-sys-outline); box-shadow: var(--md-sys-shadow); text-align: left; transition: all var(--transition-duration); }
        .advanced-search-input-group { display: flex; align-items: center; gap: 16px; }
        .advanced-search-input-group label { font-weight: 500; flex-shrink: 0; }
        .advanced-search-input-group input { width: 100%; font-size: 1rem; padding: 12px 16px; border: 1px solid var(--md-sys-outline); border-radius: var(--border-radius-medium); background-color: var(--md-sys-surface-container); color: var(--md-sys-on-surface); }
        .advanced-search-input-group input:focus { outline: none; border-color: var(--md-sys-primary); box-shadow: 0 0 0 4px var(--md-sys-primary-container); }
        .search-conditions-display { width: 100%; max-width: 900px; margin: -0.5rem auto 2.5rem; padding: 0 20px; text-align: left; color: var(--md-sys-on-surface-variant); display: flex; align-items: center; flex-wrap: wrap; }
        .search-conditions-display .prefix { font-weight: 500; margin-right: 8px; margin-bottom: 8px; }
        .keyword-tag { display: inline-block; background-color: var(--md-sys-primary-container); color: var(--md-sys-on-primary-container); padding: 6px 12px; border-radius: 16px; font-size: 0.9rem; margin-right: 8px; margin-bottom: 8px; cursor: pointer; transition: all var(--transition-duration) var(--transition-easing); }
        .keyword-tag:hover { background-color: var(--md-sys-error-container); color: var(--md-sys-on-error-container); text-decoration: line-through; transform: translateY(-2px); }
        #similarity-condition-display .keyword-tag { background-color: var(--md-sys-success-container); color: var(--md-sys-on-success-container); }
        #similarity-condition-display .keyword-tag:hover { background-color: var(--md-sys-error-container); }
        .results-container { width: 90%; max-width: 1400px; margin: 80px auto 20px; padding: 0 24px; text-align: center; }
        .search-results { column-count: 5; column-gap: 16px; text-align: left; }
        .result-item { margin: 0 0 16px; background-color: var(--md-sys-surface); border-radius: var(--border-radius-medium); overflow: hidden; box-shadow: var(--md-sys-shadow); transition: transform 0.2s var(--transition-easing), box-shadow 0.2s var(--transition-easing); position: relative; break-inside: avoid; margin-bottom: 16px; }
        .result-item-clickable { cursor: pointer; }
        .result-item:hover { transform: translateY(-6px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 8px 24px rgba(0, 0, 0, 0.1); }
        .result-item img, .result-item video { width: 100%; height: auto; display: block; background-color: var(--md-sys-surface-container); }
        .result-item-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 12px; color: #ffffff; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%); opacity: 0; visibility: hidden; transform: translateY(10px); transition: all var(--transition-duration) var(--transition-easing); font-size: 0.9rem; display: flex; flex-direction: column; gap: 8px; }
        .result-item:hover .result-item-overlay { opacity: 1; visibility: visible; transform: translateY(0); }
        .overlay-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .overlay-btn { background-color: rgba(255, 255, 255, 0.9); color: #000; border: none; border-radius: var(--border-radius-small); padding: 6px 12px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: background-color var(--transition-duration); flex-shrink: 0; }
        .overlay-btn:hover { background-color: #fff; }
        .copy-menu-container { display: flex; align-items: center; gap: 6px; background-color: rgba(0, 0, 0, 0.3); padding: 4px 8px; border-radius: var(--border-radius-small); overflow: hidden; flex-wrap: wrap; }
        .copy-format-link { color: #fff; text-decoration: none; font-weight: 500; padding: 2px 4px; border-radius: 4px; }
        .copy-format-link:hover { background-color: rgba(255, 255, 255, 0.2); }
        .score-display { text-align: right; width: 100%; font-size: 0.8rem; opacity: 0.8; }
        .detail-container, .convert-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .content-wrapper { display: flex; flex-direction: row; align-items: center; gap: 48px; width: 100%; max-width: 900px; padding: 24px; }
        .preview-pane { flex-shrink: 0; width: 40%; display: flex; align-items: center; justify-content: center; }
        .preview-pane img, .preview-pane video { max-width: 100%; max-height: 40vh; object-fit: contain; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1)); border-radius: var(--border-radius-small); }
        .info-pane { flex-grow: 1; font-size: 1.1rem; color: var(--md-sys-on-surface-variant); width: 60%; display: flex; flex-direction: column; align-items: flex-start; }
        .info-pane h2 { color: var(--md-sys-on-surface); margin-top: 0; width: 100%; }
        .info-pane ul { list-style: none; padding: 0; margin: 0 0 32px 0; width: 100%;}
        .info-pane li { margin-bottom: 16px; display: flex; }
        .info-pane strong { color: var(--md-sys-on-surface); font-weight: 500; display: inline-block; width: 100px; flex-shrink: 0;}
        .action-group { position: relative; width: 100%; text-align: center; }
        .action-button { background-color: var(--md-sys-primary); color: var(--md-sys-on-primary); border: none; border-radius: var(--border-radius-large); padding: 16px 32px; font-size: 1.1rem; font-weight: 500; cursor: pointer; transition: all var(--transition-duration); width: 100%; }
        .action-button:hover { opacity: 0.9; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .action-button:disabled { background-color: var(--md-sys-outline); cursor: not-allowed; }
        .secondary-button { background-color: var(--md-sys-surface); color: var(--md-sys-on-surface-variant); border: 1px solid var(--md-sys-outline); }
        .secondary-button:hover { background-color: var(--md-sys-primary-container); border-color: var(--md-sys-primary); }
        .detail-actions-container { display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 250px; }
        .custom-convert-link { font-size: 0.9rem; color: var(--md-sys-on-surface-variant); cursor: pointer; text-decoration: underline; margin-top: -8px; display: block; text-align: center; }
        #detail-relatives-container { display: flex; flex-direction: column; align-items: center; gap: 24px; width: 100%; }
        .relative-item { text-align: center; }
        .relative-item img, .relative-item video { max-width: 100%; max-height: 250px; object-fit: contain; border-radius: var(--border-radius-small); margin-bottom: 8px; background-color: var(--md-sys-surface); }
        .relative-item-info { font-size: 0.9rem; color: var(--md-sys-on-surface-variant); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--md-sys-on-surface); }
        .form-group select, .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 12px; border-radius: var(--border-radius-small); border: 1px solid var(--md-sys-outline); background-color: var(--md-sys-surface-container); color: var(--md-sys-on-surface); font-size: 1rem; }
        .form-group .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .form-group .checkbox-group input[type="checkbox"] { width: 1.3em; height: 1.3em; accent-color: var(--md-sys-primary); }
        .form-group .range-group { display: flex; align-items: center; gap: 16px; }
        .form-group .range-group input[type="range"] { flex-grow: 1; }
        .form-group .range-group input[type="number"] { width: 70px; }
        .form-group:has(input:disabled) { opacity: 0.5; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--md-sys-surface-container); border-radius: 4px; outline: none; opacity: 0.8; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--md-sys-primary); cursor: pointer; border-radius: 50%; border: 2px solid var(--md-sys-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--md-sys-primary); cursor: pointer; border-radius: 50%; border: 2px solid var(--md-sys-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .convert-status { margin-top: 1.5rem; padding: 1rem; border-radius: var(--border-radius-small); word-break: break-word; }
        .convert-status.success { background-color: var(--md-sys-primary-container); color: var(--md-sys-on-primary-container); }
        .convert-status.success span { text-decoration: underline; cursor: pointer; font-weight: bold; }
        .convert-status.error { background-color: var(--md-sys-error-container); color: var(--md-sys-on-error-container); white-space: pre-wrap; }
        .popover { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background-color: var(--md-sys-surface); border: 1px solid var(--md-sys-outline); border-radius: var(--border-radius-medium); box-shadow: var(--md-sys-shadow); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s var(--transition-easing); min-width: 200px; transform-origin: bottom center; }
        .popover.is-visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }
        .popover ul { list-style: none; margin: 0; padding: 8px; }
        .popover li { padding: 8px 12px; margin: 0; cursor: pointer; border-radius: var(--border-radius-small); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .popover li:hover { background-color: var(--md-sys-surface-container); }
        #copy-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(20, 20, 20, 0.85); color: white; padding: 12px 24px; border-radius: var(--border-radius-large); z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; }
        #copy-toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }
        .modal { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity var(--transition-duration), visibility var(--transition-duration); }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--md-sys-surface); padding: 32px; border-radius: var(--border-radius-large); width: 90%; max-width: 550px; position: relative; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform var(--transition-duration) var(--transition-easing); }
        .modal.is-open .modal-content { transform: scale(1); }
        .close-btn { color: var(--md-sys-on-surface-variant); position: absolute; top: 16px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color var(--transition-duration); }
        .close-btn:hover { color: var(--md-sys-on-surface); }
        .modal-content h2 { margin-top: 0; }
        .modal-content input[type="text"], .modal-content button { width: 100%; padding: 12px 16px; font-size: 1rem; border-radius: var(--border-radius-small); border: 1px solid var(--md-sys-outline); }
        .modal-content button { background-color: var(--md-sys-primary); color: var(--md-sys-on-primary); border: none; cursor: pointer; margin-top: 1rem; transition: background-color var(--transition-duration); }
        .modal-content button:hover { opacity: 0.9; }
        @media (max-width: 1200px) { .search-results { column-count: 4; } }
        @media (max-width: 992px) { .search-results { column-count: 3; } }
        @media (max-width: 768px) { .search-container { flex-direction: row; flex-wrap: wrap; justify-content: center; } .search-bar { width: 100%; margin-bottom: 12px; } .advanced-search-toggle-btn, .options-bar { height: 50px; padding: 0 16px; } .advanced-search-panel { margin-top: 1rem; } .content-wrapper { flex-direction: column; text-align: center; gap: 24px; } .preview-pane { width: 100%; max-width: 300px; } .info-pane { width: 100%; align-items: center; } .info-pane li { justify-content: center; } }
        @media (max-width: 600px) { .title { font-size: 2.2rem; } .search-input { padding: 16px 55px 16px 20px; } .search-results { column-count: 2; gap: 16px; } .result-item { margin-bottom: 16px; } .modal-content { padding: 24px; } }
        @media (max-width: 480px) { .search-results { column-count: 1; } }
    </style>
</head>
<body>

    <header class="header">
        <button class="settings-btn" id="open-settings-modal" title="索引设置">⚙️</button>
    </header>

    <main id="view-main" class="app-view main-container">
        <h1 class="title">表情贴纸语义搜索</h1>
        <div class="search-container">
            <form id="search-form" class="search-bar">
                <input type="text" id="query" class="search-input" placeholder="输入中文描述，或添加一个相似图片" required>
                <button type="submit" class="search-button" title="搜索">🔍</button>
            </form>
            <button id="toggle-advanced-search-btn" class="advanced-search-toggle-btn" title="高级搜索">高级搜索</button>
            <div class="options-bar">
                <label for="top_k">给我来</label>
                <input type="number" id="top_k" value="50" min="1" max="100">
                <label for="top_k">张!</label>
            </div>
        </div>
        
        <div id="advanced-search-panel" class="advanced-search-panel hidden">
            <div class="advanced-search-input-group">
                <label for="negative_query_input">排除关键词:</label>
                <input type="text" id="negative_query_input" placeholder="输入后按回车键添加...">
            </div>
        </div>
        
        <div id="negative-keywords-display" class="search-conditions-display hidden"></div>
        <div id="similarity-condition-display" class="search-conditions-display hidden"></div>

        <div class="status-message" id="status-message"></div>
        <div class="results-container">
            <div class="search-results" id="search-results"></div>
            <button id="load-more-btn" class="action-button secondary-button hidden" style="margin-top: 24px; width: auto;">加载更多</button>
        </div>
    </main>

    <div id="view-detail" class="app-view detail-container hidden">
        <div class="content-wrapper">
            <div class="preview-pane">
                <div id="detail-media-container"></div>
                <div id="detail-relatives-container" class="hidden"></div>
            </div>
            <div class="info-pane">
                <ul>
                    <li><strong>文件名:</strong> <span id="detail-filename"></span></li>
                    <li><strong>文件大小:</strong> <span id="detail-size"></span></li>
                    <li><strong>尺寸:</strong> <span id="detail-dimensions"></span></li>
                    <li><strong>日期:</strong> <span id="detail-date"></span></li>
                </ul>
                <div class="detail-actions-container">
                    <div class="action-group" id="detail-copy-group">
                        <button class="action-button" id="copy-image-btn">拷贝图像</button>
                        <div class="popover" id="copy-popover"></div>
                    </div>
                    <a class="custom-convert-link" id="toggle-relatives-link" style="margin-top: 0;">查看所有图像 ></a>
                    <div class="action-group" id="detail-convert-group" style="margin-top: 8px;">
                        <button class="action-button secondary-button" id="convert-gif-btn">转为 GIF</button>
                        <div class="popover" id="convert-popover"></div>
                    </div>
                    <a class="custom-convert-link" id="custom-convert-link">自定义转换 ></a>
                    <button class="action-button secondary-button" id="back-to-results-btn">返回</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="view-convert-webp" class="app-view convert-container hidden">
        <div class="content-wrapper">
            <div class="preview-pane" id="webp-convert-preview"></div>
            <div class="info-pane">
                <h2 id="webp-convert-title">转换 WEBP</h2>
                <form id="webp-convert-form">
                    <div class="form-group">
                        <label for="webp-target-format">目标格式:</label>
                        <select id="webp-target-format">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPG</option>
                            <option value="gif">GIF</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="webp-scale-input">缩放: <span id="webp-scale-display">1</span></label>
                        <div class="range-group">
                             <input type="range" id="webp-scale-slider" min="0.1" max="4" step="0.1" value="1">
                             <input type="number" id="webp-scale-input" min="0.1" max="4" step="0.1" value="1">
                        </div>
                    </div>
                    <div class="action-group">
                        <button type="submit" class="action-button">开始转换</button>
                        <button type="button" class="action-button secondary-button" id="back-from-webp-convert-btn" style="margin-top: 12px;">返回</button>
                    </div>
                </form>
                <div id="webp-convert-status" class="convert-status hidden"></div>
            </div>
        </div>
    </div>

    <div id="view-convert-webm" class="app-view convert-container hidden">
         <div class="content-wrapper">
            <div class="preview-pane" id="webm-convert-preview"></div>
            <div class="info-pane">
                <h2 id="webm-convert-title">将 WEBM 转换为 GIF</h2>
                <form id="webm-convert-form">
                    <div class="form-group">
                        <label for="webm-scale-input">缩放: <span id="webm-scale-display">1</span></label>
                        <div class="range-group">
                             <input type="range" id="webm-scale-slider" min="0.1" max="4" step="0.1" value="1">
                             <input type="number" id="webm-scale-input" min="0.1" max="4" step="0.1" value="1">
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="webm-algorithm">算法:</label>
                        <select id="webm-algorithm">
                            <option value="fast_bilinear">fast_bilinear (最快)</option>
                            <option value="neighbor">neighbor (像素化)</option>
                            <option value="bilinear">bilinear (模糊)</option>
                            <option value="bicubic">bicubic (平衡)</option>
                            <option value="area">area (适合缩小)</option>
                            <option value="lanczos" selected>lanczos (高质量)</option>
                            <option value="sinc">sinc (高质量)</option>
                            <option value="spline">spline (高质量)</option>
                        </select>
                    </div>
                    <div class="action-group">
                        <button type="submit" class="action-button">开始转换</button>
                        <button type="button" class="action-button secondary-button" id="back-from-webm-convert-btn" style="margin-top: 12px;">返回</button>
                    </div>
                </form>
                <div id="webm-convert-status" class="convert-status hidden"></div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-settings-modal">&times;</span>
            <h2>索引设置</h2>
            <form id="index-form">
                <div style="margin-bottom: 1rem;">
                    <label for="image-dir" style="display: block; margin-bottom: 0.5rem;">图片文件夹路径</label>
                    <input type="text" id="image-dir" value="{{ last_indexed_dir }}" placeholder="例如: /Users/username/Pictures" required>
                </div>
                <button type="submit" id="index-button">开始/更新索引</button>
            </form>
            <div id="index-results" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div id="copy-toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Global State ---
    let currentDetailItem = null;
    let popoverHideTimer = null;
    const isLocalAccess = ['localhost', '127.0.0.1'].includes(window.location.hostname);
    let negativeKeywords = [];
    let similarityCondition = null; 
    let currentOffset = 0;
    let lastSearchType = null;
    let lastSearchParams = {};

    // --- Element Caching ---
    const views = {
        main: document.getElementById('view-main'),
        detail: document.getElementById('view-detail'),
        convertWebp: document.getElementById('view-convert-webp'),
        convertWebm: document.getElementById('view-convert-webm'),
    };
    const settingsBtn = document.getElementById('open-settings-modal');
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('query');
    const searchResults = document.getElementById('search-results');
    const statusMessage = document.getElementById('status-message');
    const copyToast = document.getElementById('copy-toast');
    const toggleAdvancedBtn = document.getElementById('toggle-advanced-search-btn');
    const advancedPanel = document.getElementById('advanced-search-panel');
    const negativeQueryInput = document.getElementById('negative_query_input');
    const keywordsDisplayContainer = document.getElementById('negative-keywords-display');
    const similarityContainer = document.getElementById('similarity-condition-display');
    const detailMediaContainer = document.getElementById('detail-media-container');
    const detailRelativesContainer = document.getElementById('detail-relatives-container');
    const toggleRelativesLink = document.getElementById('toggle-relatives-link');
    const copyImageBtn = document.getElementById('copy-image-btn');
    const copyPopover = document.getElementById('copy-popover');
    const detailCopyGroup = document.getElementById('detail-copy-group');
    const convertGifBtn = document.getElementById('convert-gif-btn');
    const convertPopover = document.getElementById('convert-popover');
    const detailConvertGroup = document.getElementById('detail-convert-group');
    const customConvertLink = document.getElementById('custom-convert-link');
    const webpConvertForm = document.getElementById('webp-convert-form');
    const webpConvertStatus = document.getElementById('webp-convert-status');
    const webmConvertForm = document.getElementById('webm-convert-form');
    const webmConvertStatus = document.getElementById('webm-convert-status');
    const loadMoreBtn = document.getElementById('load-more-btn');

    // --- Initial Setup ---
    if (!isLocalAccess) {
        settingsBtn.classList.add('hidden');
    }

    // --- View Management & Rendering ---
    function showView(viewName, data = null) {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        if (views[viewName]) {
            views[viewName].classList.remove('hidden');
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }
        if (viewName === 'detail' && data) {
            currentDetailItem = data;
            populateDetailView(data);
        } else if (viewName === 'convertWebp' && data) {
            populateWebpConvertView(data);
        } else if (viewName === 'convertWebm' && data) {
            populateWebmConvertView(data);
        }
    }

    function renderResults(results, isAppending = false) {
        if (!isAppending) {
            searchResults.innerHTML = '';
        }
        if (results.length === 0 && !isAppending) {
            statusMessage.textContent = '未找到匹配的图片。';
            return;
        }
        
        results.forEach(item => {
            const resultElement = document.createElement('figure');
            resultElement.className = 'result-item';
            resultElement.dataset.itemData = JSON.stringify(item);

            const mediaWrapper = document.createElement('div');
            mediaWrapper.className = 'result-item-clickable';
            mediaWrapper.appendChild(createMediaElement(item));

            let copyLinks = '';
            if (isLocalAccess && item.available_formats) {
                copyLinks = item.available_formats.map(fmt => 
                    `<a href="#" class="copy-format-link" data-path="${fmt.path}" data-location="${fmt.location}">${fmt.format.toUpperCase()}</a>`
                ).join('');
            }

            const overlay = document.createElement('div');
            overlay.className = 'result-item-overlay';
            overlay.innerHTML = `
                <div class="overlay-actions">
                    <button class="overlay-btn find-similar-btn" data-path="${item.path}">查找相似</button>
                    <button class="overlay-btn add-to-condition-btn" data-path="${item.path}" data-filename="${item.filename}">添加到搜索条件</button>
                    ${copyLinks ? `<div class="copy-menu-container"><span>复制:</span>${copyLinks}</div>` : ''}
                </div>
                <div class="score-display">匹配度: ${item.score.toFixed(4)}</div>`;
            
            resultElement.appendChild(mediaWrapper);
            resultElement.appendChild(overlay);
            searchResults.appendChild(resultElement);
        });
    }
    
    function renderNegativeKeywords() {
        keywordsDisplayContainer.innerHTML = '';
        if (negativeKeywords.length > 0) {
            keywordsDisplayContainer.classList.remove('hidden');
            const prefix = document.createElement('span');
            prefix.className = 'prefix';
            prefix.textContent = '已排除:';
            keywordsDisplayContainer.appendChild(prefix);
            negativeKeywords.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'keyword-tag';
                tag.textContent = keyword;
                tag.title = '点击移除';
                tag.addEventListener('click', () => {
                    negativeKeywords = negativeKeywords.filter(k => k !== keyword);
                    renderNegativeKeywords();
                });
                keywordsDisplayContainer.appendChild(tag);
            });
        } else {
            keywordsDisplayContainer.classList.add('hidden');
        }
    }

    function renderSimilarityCondition() {
        similarityContainer.innerHTML = '';
        if (similarityCondition) {
            similarityContainer.classList.remove('hidden');
            const prefix = document.createElement('span');
            prefix.className = 'prefix';
            prefix.textContent = '相似于:';
            similarityContainer.appendChild(prefix);
            const tag = document.createElement('span');
            tag.className = 'keyword-tag';
            tag.textContent = similarityCondition.filename;
            tag.title = '点击移除';
            tag.addEventListener('click', () => {
                similarityCondition = null;
                renderSimilarityCondition();
            });
            similarityContainer.appendChild(tag);
        } else {
            similarityContainer.classList.add('hidden');
        }
    }

    async function populateDetailView(item) {
        detailMediaContainer.classList.remove('hidden');
        detailRelativesContainer.classList.add('hidden');
        detailRelativesContainer.innerHTML = '';
        copyPopover.innerHTML = '';
        convertPopover.innerHTML = '';
        detailMediaContainer.innerHTML = createMediaElement(item).outerHTML;
        document.getElementById('detail-filename').textContent = item.filename;
        document.getElementById('detail-size').textContent = formatBytes(item.size);
        document.getElementById('detail-dimensions').textContent = item.dimensions ? item.dimensions.join(' x ') : 'N/A';
        document.getElementById('detail-date').textContent = new Date(item.date).toLocaleDateString();

        copyImageBtn.removeEventListener('click', handleCopyClick);
        copyImageBtn.removeEventListener('click', handleToggleRelatives);
        toggleRelativesLink.removeEventListener('click', handleToggleRelatives);

        if (isLocalAccess) {
            copyImageBtn.textContent = '拷贝图像';
            copyImageBtn.addEventListener('click', handleCopyClick);
            toggleRelativesLink.innerHTML = '查看所有图像 >';
            toggleRelativesLink.addEventListener('click', handleToggleRelatives);
            detailCopyGroup.classList.remove('hidden');
            toggleRelativesLink.classList.remove('hidden');
        } else {
            copyImageBtn.textContent = '查看所有图像';
            copyImageBtn.addEventListener('click', handleToggleRelatives);
            detailCopyGroup.classList.remove('hidden');
            toggleRelativesLink.classList.add('hidden');
        }

        if (item.type === '.webp' || item.type === '.webm') {
            detailConvertGroup.classList.remove('hidden');
            customConvertLink.classList.remove('hidden');
        } else {
            detailConvertGroup.classList.add('hidden');
            customConvertLink.classList.add('hidden');
        }
        await updatePopovers(item, isLocalAccess);
    }

    async function updatePopovers(item, isLocal = true) {
        if (isLocal) {
            try {
                const response = await fetch(`/api/find_relatives?path=${encodeURIComponent(item.path)}`);
                const data = await response.json();
                if (data.status === 'success' && data.files.length > 1) {
                    const list = document.createElement('ul');
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        li.textContent = file.filename;
                        li.title = file.filename;
                        li.onclick = () => {
                            const location = file.url.includes('stickers_converted') ? 'converted' : 'index';
                            copyFile(file.path, null, location);
                            copyPopover.classList.remove('is-visible');
                        };
                        list.appendChild(li);
                    });
                    copyPopover.appendChild(list);
                }
            } catch (err) {
                console.error("Failed to prepare copy popover:", err);
            }
        }
        if (item.type === '.webp') {
            const list = document.createElement('ul');
            ['png', 'jpeg'].forEach(format => {
                 const li = document.createElement('li');
                 li.textContent = `转为 ${format.toUpperCase()}`;
                 li.onclick = () => {
                     convertFile(item.path, format, { scale: 1.0 }, true);
                     convertPopover.classList.remove('is-visible');
                 };
                 list.appendChild(li);
            });
            convertPopover.appendChild(list);
        }
    }

    function populateWebpConvertView(item) {
        document.getElementById('webp-convert-preview').innerHTML = createMediaElement(item).outerHTML;
        document.getElementById('webp-convert-title').textContent = `转换 ${item.type.toUpperCase().slice(1)}`;
        webpConvertForm.reset();
        document.getElementById('webp-scale-display').textContent = '1';
        webpConvertStatus.classList.add('hidden');
    }

    function populateWebmConvertView(item) {
        document.getElementById('webm-convert-preview').innerHTML = createMediaElement(item).outerHTML;
        webmConvertForm.reset();
        document.getElementById('webm-scale-display').textContent = '1';
        webmConvertStatus.classList.add('hidden');
    }

    // --- Event Handlers ---
    searchForm.addEventListener('submit', handleSearch);

    searchResults.addEventListener('click', (e) => {
        const findSimilarBtn = e.target.closest('.find-similar-btn');
        const addToConditionBtn = e.target.closest('.add-to-condition-btn');
        const copyLink = e.target.closest('.copy-format-link');
        const clickableArea = e.target.closest('.result-item-clickable');

        if (findSimilarBtn) { e.preventDefault(); handleFindSimilar(findSimilarBtn.dataset.path); }
        else if (addToConditionBtn) { e.preventDefault(); similarityCondition = { path: addToConditionBtn.dataset.path, filename: addToConditionBtn.dataset.filename }; renderSimilarityCondition(); showToast(`已添加相似条件: ${similarityCondition.filename}`); }
        else if (copyLink) { e.preventDefault(); copyFile(copyLink.dataset.path, null, copyLink.dataset.location); }
        else if (clickableArea) { const itemElement = clickableArea.closest('.result-item'); if (itemElement && itemElement.dataset.itemData) { showView('detail', JSON.parse(itemElement.dataset.itemData)); } }
    });

    toggleAdvancedBtn.addEventListener('click', () => {
        advancedPanel.classList.toggle('hidden');
        toggleAdvancedBtn.classList.toggle('active');
    });
    
    negativeQueryInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const keyword = negativeQueryInput.value.trim();
            if (keyword && !negativeKeywords.includes(keyword)) {
                negativeKeywords.push(keyword);
                renderNegativeKeywords();
            }
            negativeQueryInput.value = '';
        }
    });

    loadMoreBtn.addEventListener('click', () => {
        const topK = parseInt(document.getElementById('top_k').value, 10);
        currentOffset += topK;
        performSearch(true);
    });

    document.getElementById('back-to-results-btn').addEventListener('click', () => showView('main'));
    document.getElementById('back-from-webp-convert-btn').addEventListener('click', () => showView('detail', currentDetailItem));
    document.getElementById('back-from-webm-convert-btn').addEventListener('click', () => showView('detail', currentDetailItem));

    function handleCopyClick() { const preferredFormat = (currentDetailItem.type === '.webp' || currentDetailItem.type === '.webm') ? '.gif' : null; copyFile(currentDetailItem.path, preferredFormat); }
    convertGifBtn.addEventListener('click', () => { if (!currentDetailItem) return; const defaultParams = { scale: 1.0, algorithm: 'lanczos' }; convertFile(currentDetailItem.path, 'gif', defaultParams, true); });
    customConvertLink.addEventListener('click', () => { if (!currentDetailItem) return; if (currentDetailItem.type === '.webp') { showView('convertWebp', currentDetailItem); } else if (currentDetailItem.type === '.webm') { showView('convertWebm', currentDetailItem); } });
    detailCopyGroup.addEventListener('mouseenter', () => { if (isLocalAccess && copyPopover.innerHTML.trim() !== '') { clearTimeout(popoverHideTimer); copyPopover.classList.add('is-visible'); } });
    detailCopyGroup.addEventListener('mouseleave', () => { popoverHideTimer = setTimeout(() => copyPopover.classList.remove('is-visible'), 300); });
    detailConvertGroup.addEventListener('mouseenter', () => { if (convertPopover.innerHTML.trim() !== '') { clearTimeout(popoverHideTimer); convertPopover.classList.add('is-visible'); } });
    detailConvertGroup.addEventListener('mouseleave', () => { popoverHideTimer = setTimeout(() => convertPopover.classList.remove('is-visible'), 300); });
    webpConvertForm.addEventListener('submit', e => { e.preventDefault(); const targetFormat = document.getElementById('webp-target-format').value; const scale = document.getElementById('webp-scale-input').value; convertFile(currentDetailItem.path, targetFormat, { scale }, false, 'webp'); });
    webmConvertForm.addEventListener('submit', e => { e.preventDefault(); const params = { scale: document.getElementById('webm-scale-input').value, algorithm: document.getElementById('webm-algorithm').value }; convertFile(currentDetailItem.path, 'gif', params, false, 'webm'); });
    setupSliderSync('webp-scale-slider', 'webp-scale-input', 'webp-scale-display');
    setupSliderSync('webm-scale-slider', 'webm-scale-input', 'webm-scale-display');

    // --- API Calls & Logic ---
    function handleSearch(e) {
        if(e) e.preventDefault();
        const query = searchInput.value;
        if (!query.trim() && !similarityCondition) {
            alert('请输入搜索描述或添加一个相似图片!');
            return;
        }
        
        currentOffset = 0;
        lastSearchType = 'text';
        lastSearchParams = {
            query: query,
            top_k: document.getElementById('top_k').value,
            negative_query: negativeKeywords.join(','),
            similar_image_path: similarityCondition ? similarityCondition.path : ''
        };
        performSearch(false);
    }
    
    function handleFindSimilar(path) {
        if (!path) return;
        searchInput.value = `[相似于: ${path.split('/').pop()}]`;

        currentOffset = 0;
        lastSearchType = 'similar';
        lastSearchParams = {
            path: path,
            top_k: document.getElementById('top_k').value,
            negative_query: negativeKeywords.join(',')
        };
        performSearch(false);
    }

    async function performSearch(isLoadMore = false) {
        if (!isLoadMore) {
            searchResults.innerHTML = '';
            statusMessage.textContent = '正在搜索中...';
        } else {
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = '加载中...';
        }
        searchForm.querySelector('button').disabled = true;
        loadMoreBtn.classList.add('hidden');

        try {
            let apiUrl;
            const params = new URLSearchParams(lastSearchParams);
            if (lastSearchType === 'text') {
                apiUrl = `/api/search?${params.toString()}`;
            } else if (lastSearchType === 'similar') {
                apiUrl = `/api/search_by_image?${params.toString()}`;
            } else {
                return;
            }

            if (isLoadMore) {
                apiUrl += `&offset=${currentOffset}`;
            }

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.status === 'success') {
                if (!isLoadMore) statusMessage.textContent = '';
                renderResults(data.results, isLoadMore);
                
                const topK = parseInt(lastSearchParams.top_k, 10);
                if (data.results.length >= topK) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            } else {
                statusMessage.innerHTML = `<span style="color: var(--md-sys-error);"><strong>搜索失败:</strong> ${data.message}</span>`;
            }
        } catch (error) {
            statusMessage.innerHTML = `<span style="color: var(--md-sys-error);"><strong>网络或服务器错误:</strong> ${error}</span>`;
        } finally {
            searchForm.querySelector('button').disabled = false;
            if (isLoadMore) {
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = '加载更多';
            }
        }
    }


    async function handleToggleRelatives() {
        if (!currentDetailItem) return;
        const isHidden = detailRelativesContainer.classList.contains('hidden');
        const buttonToUpdate = isLocalAccess ? toggleRelativesLink : copyImageBtn;
        if (isHidden) {
            buttonToUpdate.textContent = '加载中...';
            try {
                const response = await fetch(`/api/find_relatives?path=${encodeURIComponent(currentDetailItem.path)}`);
                const data = await response.json();
                if (data.status === 'success') {
                    detailRelativesContainer.innerHTML = '';
                    data.files.forEach(file => {
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'relative-item';
                        itemContainer.appendChild(createMediaElement({ url: file.url, filename: file.filename, type: `.${file.format}` }));
                        const info = document.createElement('div');
                        info.className = 'relative-item-info';
                        info.textContent = `${file.format} ${formatBytes(file.size)} ${file.dimensions.join('x')}`;
                        itemContainer.appendChild(info);
                        detailRelativesContainer.appendChild(itemContainer);
                    });
                    detailMediaContainer.classList.add('hidden');
                    detailRelativesContainer.classList.remove('hidden');
                    if (isLocalAccess) buttonToUpdate.innerHTML = '隐藏所有图像 >';
                    else buttonToUpdate.textContent = '隐藏所有图像';
                } else {
                    showToast(`❌ 获取关联文件失败: ${data.message}`);
                    if (isLocalAccess) buttonToUpdate.innerHTML = '查看所有图像 >';
                    else buttonToUpdate.textContent = '查看所有图像';
                }
            } catch (err) {
                showToast('❌ 网络或服务器错误');
                if (isLocalAccess) buttonToUpdate.innerHTML = '查看所有图像 >';
                else buttonToUpdate.textContent = '查看所有图像';
            }
        } else {
            detailRelativesContainer.classList.add('hidden');
            detailMediaContainer.classList.remove('hidden');
            if (isLocalAccess) buttonToUpdate.innerHTML = '查看所有图像 >';
            else buttonToUpdate.textContent = '查看所有图像';
        }
    }

    async function copyFile(path, preferredFormat = null, location = 'index') {
        showToast('正在拷贝...');
        const body = { path, location };
        if (preferredFormat) { body.preferred_format = preferredFormat; }
        try {
            const response = await fetch('/api/copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            showToast(response.ok ? `✅ ${data.message}` : `❌ ${data.message}`);
        } catch (err) {
            showToast('❌ 拷贝失败，请检查服务是否运行。');
        }
    }
    
    async function convertFile(source_path, target_format, params, shouldCopy = false, viewType = null) {
        let statusElem, submitBtn;
        if(viewType === 'webp') { statusElem = webpConvertStatus; submitBtn = webpConvertForm.querySelector('button[type="submit"]'); }
        else if (viewType === 'webm') { statusElem = webmConvertStatus; submitBtn = webmConvertForm.querySelector('button[type="submit"]'); }
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = '转换中...'; }
        else { showToast('正在转换...'); }
        if (statusElem) { statusElem.classList.add('hidden'); }
        try {
            const response = await fetch('/api/convert', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ source_path, target_format, params }) });
            const data = await response.json();
            if (response.ok) {
                if(shouldCopy) { copyFile(data.output_path, null, 'converted'); }
                else if (statusElem) { statusElem.className = 'convert-status success'; const newFileName = data.output_path; statusElem.innerHTML = `转换成功: ${newFileName}！<span data-path="${newFileName}">点击此处拷贝</span>`; statusElem.querySelector('span').onclick = (e) => copyFile(e.target.dataset.path, null, 'converted'); statusElem.classList.remove('hidden'); }
                else { showToast(`✅ 转换成功: ${data.output_path}`); }
            } else { throw new Error(data.message); }
        } catch (err) {
            const errorMessage = err.message || '网络或服务器错误';
            if (statusElem) { statusElem.className = 'convert-status error'; statusElem.textContent = `转换失败: ${errorMessage}`; statusElem.classList.remove('hidden'); }
            else { showToast(`❌ 转换失败: ${errorMessage}`); }
        } finally {
             if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '开始转换'; }
        }
    }

    // --- Helper Functions ---
    function createMediaElement(item) { let mediaElement; if (item.type === '.webm' || item.type === '.mp4') { mediaElement = document.createElement('video'); mediaElement.src = item.url; mediaElement.autoplay = true; mediaElement.loop = true; mediaElement.muted = true; mediaElement.playsInline = true; } else { mediaElement = document.createElement('img'); mediaElement.src = item.url; mediaElement.loading = 'lazy'; } mediaElement.alt = item.filename; return mediaElement; }
    function setupSliderSync(sliderId, inputId, displayId) { const slider = document.getElementById(sliderId); const input = document.getElementById(inputId); const display = document.getElementById(displayId); slider.addEventListener('input', () => { input.value = slider.value; if(display) display.textContent = slider.value; }); input.addEventListener('input', () => { slider.value = input.value; if(display) display.textContent = input.value; }); }
    function formatBytes(bytes, decimals = 2) { if (!bytes || bytes === 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }
    function showToast(message) { clearTimeout(window.toastTimer); copyToast.textContent = message; copyToast.classList.add('show'); window.toastTimer = setTimeout(() => { copyToast.classList.remove('show'); }, 3000); }
    
    // --- Modal Logic ---
    const modal = document.getElementById('settings-modal'); const openModalBtn = document.getElementById('open-settings-modal'); const closeModalBtn = document.getElementById('close-settings-modal'); const indexForm = document.getElementById('index-form'); const indexResults = document.getElementById('index-results');
    function openModal() { modal.classList.add('is-open'); }
    function closeModal() { modal.classList.remove('is-open'); }
    openModalBtn.onclick = openModal; closeModalBtn.onclick = closeModal; modal.onclick = (event) => { if (event.target === modal) closeModal(); }; document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && modal.classList.contains('is-open')) closeModal(); });
    indexForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const imageDir = document.getElementById('image-dir').value;
        if (!imageDir) { alert('请输入图片文件夹路径!'); return; }
        const indexButton = document.getElementById('index-button');
        indexButton.disabled = true; indexButton.textContent = '处理中...'; indexResults.innerHTML = `<p>正在处理索引，请稍候...</p>`;
        try {
            const response = await fetch('/api/index', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ image_dir: imageDir }) });
            const data = await response.json();
            if (data.status === 'success' && data.summary) { indexResults.innerHTML = `<p style="color: var(--md-sys-success);">${data.summary.message}</p>`; }
            else { indexResults.innerHTML = `<p style="color: var(--md-sys-error);">${data.message}</p>`; }
        } catch (error) {
            indexResults.innerHTML = `<p style="color: var(--md-sys-error);"><strong>网络或服务器错误:</strong> ${error}</p>`;
        } finally {
            indexButton.disabled = false; indexButton.textContent = '开始/更新索引';
        }
    });
});
</script>

</body>
</html>